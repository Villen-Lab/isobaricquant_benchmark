---
title: "Comet-Mokapot-hits-input_IsobaricQuant"
author: "Alexander Hogrebe"
date: "Current version `r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libraries and functions

```{r libraries, eval=FALSE, message=FALSE, include=TRUE}

#load libraries
library(data.table)
library(foreach)

#load function to recreate old Comet peptide sequence output
peptide_gsub_Comet_old <- function(string){
  if(!is.character(string)) stop("'input' needs to be a character vector")
  
  string <- gsub("[15.9949]", "*", string, fixed=T)
  string <- gsub("n[42.0106]", "n#", string, fixed=T)
  
  return(string)
}

```

# Prepare standalone data

In addition to instructions below on how to recreate this analysis 1-to-1, input files for this analysis are available here:
(PRIDE REPOSITORY)

# Download raw files and convert to mzML

Get .raw files a18182 to a18190 from the following publication:
https://pubs.acs.org/doi/10.1021/jasms.0c00299

.raw files are accessible here:
https://www.ebi.ac.uk/pride/archive/projects/PXD020815

Convert them to mzML using default settings in MSConvert:
https://proteowizard.sourceforge.io/tools.shtml

## Comet

To use IsobaricQuant, Comet and Percolator output are needed. For Comet, a standard search with text and pin output file and max top 1 output line are needed. For Percolator, use mokapot to avoid file output problems.

Download Comet:
https://uwpr.github.io/Comet/

Use it with the following parameter files listed below (adjust the file path within to the mixed yeast-human Uniprot FASTA database):
comet_MS3.params for MS3
comet_MS2.params for MS2

Move the parameter files & the MS3-level quantified (6 total) vs MS2-level quantified (3 total) mzMLs into 2 separate folders. Rename the parameter files to "comet.params". Then execute the following commands in Windows Powershell or command line (adjust to your mzML and Comet folder paths):

```
cd C:\Local_UW\MS\_web_files\HYpro16_2021\MS3
C:\Local_UW\Software\Comet\comet_v2021.02.0\comet.win64.exe a18183_SPS_1.mzML a18184_RTS_1.mzML a18186_SPS_2.mzML a18187_RTS_2.mzML a18189_SPS_3.mzML a18190_RTS_3.mzML
cd C:\Local_UW\MS\_web_files\HYpro16_2021\MS2
C:\Local_UW\Software\Comet\comet_v2021.02.0\comet.win64.exe a18182_MS2_1.mzML a18185_MS2_2.mzML a18188_MS2_3.mzML
```

## Mokapot

Download Mokapot:
https://github.com/wfondrie/mokapot

Download and install Python (e.g. Anaconda), which is required to run Mokapot:
https://www.anaconda.com/products/individual

Execute the following lines via anaconda prompt (adjust folder path):

```
cd C:\Local_UW\MS\_web_files\HYpro16_2021\MS3
mokapot a18183_SPS_1.pin -r a18183_SPS_1
mokapot a18184_RTS_1.pin -r a18184_RTS_1
mokapot a18186_SPS_2.pin -r a18186_SPS_2
mokapot a18187_RTS_2.pin -r a18187_RTS_2
mokapot a18189_SPS_3.pin -r a18189_SPS_3
mokapot a18190_RTS_3.pin -r a18190_RTS_3
cd C:\Local_UW\MS\_web_files\HYpro16_2021\MS2
mokapot a18182_MS2_1.pin -r a18182_MS2_1
mokapot a18185_MS2_2.pin -r a18185_MS2_2
mokapot a18188_MS2_3.pin -r a18188_MS2_3
```

## IsobaricQuant preparation

To run IsobaricQuant, the .txt output files generated by Comet and the .mokapot.psms.txt output files generated by Mokapot need to be copied into the "data" folder. Then run the script below, to generate a IQ hits input file.

```{r hits_input_files, eval=FALSE, message=FALSE, include=TRUE}

file_list <- c("a18182_MS2_1", "a18183_SPS_1", "a18184_RTS_1",
               "a18185_MS2_2", "a18186_SPS_2", "a18187_RTS_2",
               "a18188_MS2_3", "a18189_SPS_3", "a18190_RTS_3")

file <- file_list[1]

foreach(file = file_list) %do% {
  
  #prepare data, by filtering Comet hits with Percolator output
  data <- fread(paste0("data/", file, ".txt"), skip = 1)
  data <- data[!like(protein, "^DECOY_")]
  perc <- fread(paste0("data/", file, ".mokapot.psms.txt"))
  
  #create tag and merge two datasets
  data[, tag := paste0(file, "_", scan, "_", charge, "_", num)]
  data <- merge(x=data, y=perc, by.x="tag", by.y="SpecId", all.x=T, all.y=F)
  setkey(data, scan)
  
  #filter comet output based on q-value
  data <- data[`mokapot q-value`<=0.01]
  print(paste0(file, " yields ", data[, .N], " entries of q-value < 0.01"))
  
  #create row number column
  data[, PeptideID := 1:.N]
  #export IsobaricQuant hits input file
  data_exp <- data[, .(SearchID = 1, PeptideID, peptide_gsub_Comet_old(modified_peptide),
                       reference = gsub("^([^\\,]*).*$", "\\1", protein, perl=T), charge, ScanNumber = scan,
                       mz = (exp_neutral_mass+charge*1.0073)/charge)]
  fwrite(data_exp, file = paste0(path, "/export/", file, "_hits_oldComet.csv"), col.names = F)
  
  return(NULL)
}

```

## IsobaricQuant

Copy IsobaricQuant.jar into the same folder as the config, mzML and hits output file generated above.
To start the GUI from Windows PowerShell, execute the following commands (adjust path to folder with IsobaricQuant):

```
cd C:\Local_UW\Projects\Isobaric_quant\R_isobaric_quant\AH013d_HYpro_2021\export
java --add-opens java.base/java.lang=ALL-UNNAMED -jar .\IsobaricQuant.jar
```

To calculate csv output reports, use the _hits.csv files generated above together with the IQ config and mzML files to create TMT quant reports below using the following commands in Windows PowerShell (adjust path to folder with IsobaricQuant):

```
cd C:\Local_UW\Projects\Isobaric_quant\R_isobaric_quant\AH013d_HYpro_2021\export
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_IT-OT_MS3-TMTpro.conf -mzf a18183_SPS_1.mzML -h a18183_SPS_1_hits_oldComet.csv -o a18183_SPS_1_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_IT-OT_MS3-TMTpro.conf -mzf a18184_RTS_1.mzML -h a18184_RTS_1_hits_oldComet.csv -o a18184_RTS_1_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_IT-OT_MS3-TMTpro.conf -mzf a18186_SPS_2.mzML -h a18186_SPS_2_hits_oldComet.csv -o a18186_SPS_2_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_IT-OT_MS3-TMTpro.conf -mzf a18187_RTS_2.mzML -h a18187_RTS_2_hits_oldComet.csv -o a18187_RTS_2_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_IT-OT_MS3-TMTpro.conf -mzf a18189_SPS_3.mzML -h a18189_SPS_3_hits_oldComet.csv -o a18189_SPS_3_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_IT-OT_MS3-TMTpro.conf -mzf a18190_RTS_3.mzML -h a18190_RTS_3_hits_oldComet.csv -o a18190_RTS_3_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_OT_MS2-TMTpro.conf -mzf a18182_MS2_1.mzML -h a18182_MS2_1_hits_oldComet.csv -o a18182_MS2_1_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_OT_MS2-TMTpro.conf -mzf a18185_MS2_2.mzML -h a18185_MS2_2_hits_oldComet.csv -o a18185_MS2_2_output\
java -jar --add-opens java.base/java.lang=ALL-UNNAMED IsobaricQuant.jar -c config_OT_MS2-TMTpro.conf -mzf a18188_MS2_3.mzML -h a18188_MS2_3_hits_oldComet.csv -o a18188_MS2_3_output\
```
